<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Gra S≈Ç√≥wek</title>
<link rel="icon" href="favicon.ico">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.json">
<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:system-ui,sans-serif;
background:radial-gradient(circle at top,#fff6d8,#f1deb0)}
#categoryScreen,#menu,#resultsScreen{display:none;flex-direction:column;align-items:center;justify-content:center;height:100%}
#categoryScreen{display:flex} /* pierwszy ekran po wej≈õciu */
.card{background:#fffaf0;padding:30px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.15);text-align:center;font-weight:900;max-width:320px;width:90%}
h1{margin:0 0 20px;font-size:28px}
.menuBtns{display:flex;flex-direction:column;gap:12px;margin-top:18px}
.btnFlat{
  width:100%;
  padding:14px 18px;
  border-radius:14px;
  border:none;
  background:#ffffffd9;
  color:#1f2937;
  font-size:16px;
  font-weight:800;
  cursor:pointer;
  box-shadow:inset 0 0 0 1px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06);
  transition:transform .16s ease, background .16s ease, box-shadow .16s ease;
}
.btnFlat:hover{background:#ffffff;transform:translateY(-1px)}
.btnFlat:active{transform:translateY(0);box-shadow:inset 0 0 0 1px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.05)}
.btnFlat.small{font-size:15px;padding:12px 16px;font-weight:800}
.btnFlat.danger{color:#b91c1c}
#app{display:none;flex-direction:column;height:100%}
header{padding:14px 12px 10px;margin-top:env(safe-area-inset-top);margin-bottom:8px;text-align:center}
#words{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;padding:10px 12px;background:#fffaf0;border-radius:14px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
.word{padding:6px 12px;border-radius:999px;border:2px solid #e7d6a8;background:#fffaf0;font-weight:900;font-size:16px}
.word.off{opacity:.35;text-decoration:line-through}
.word.on{background:#eef6ff;border-color:#b9d6ff}
.word.found{background:rgba(34,197,94,.3);border-color:#22c55e}
#board{
  flex:1;
  display:grid;
  gap:8px;
  padding:30px 12px;
  touch-action:none;
  box-sizing:border-box;
}
.cell{
  background:#fffaf0;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  font-weight:900;
  user-select:none;
  transition:transform 0.9s ease-in-out, background 0.4s;
}
.cell.sel{background:#c7e0ff}
.cell.hit{background:rgba(34,197,94,.45)}
footer{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;padding-bottom:calc(28px + env(safe-area-inset-bottom))}
#timer{width:64px;height:64px;border-radius:50%;background:conic-gradient(#2563eb var(--p),rgba(0,0,0,.15) 0);display:flex;align-items:center;justify-content:center}
#timer span{background:#fffaf0;width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:18px}
.btn{padding:10px 14px;border-radius:12px;border:none;background:#2563eb;color:#fff;font-weight:900;cursor:pointer}
.iconBtn{width:46px;height:46px;border-radius:12px;border:none;background:#2563eb;color:#fff;font-weight:900;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 15px rgba(37,99,235,.3)}
.iconBtn:active{transform:translateY(2px);box-shadow:0 3px 8px rgba(37,99,235,.3)}
.iconBtn.off{background:#6b7280;box-shadow:0 6px 15px rgba(107,114,128,.25)}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center}
#modal{background:#fffaf0;padding:30px;border-radius:20px;text-align:center;font-weight:900;max-width:300px;width:90%}
:root{--app-w:390px;--app-h:780px}
body{display:flex;align-items:center;justify-content:center;background:#d9cfae}
#shell{width:100%;max-width:var(--app-w);height:100vh;max-height:var(--app-h);margin:auto;background:inherit;overflow:hidden;position:relative}
#resultsScreen{flex-direction:column;padding:20px 20px 40px;box-sizing:border-box;overflow-y:auto;text-align:center;background:#fffaf0;border-radius:20px;margin:10px}
#resultsScreen h1{font-size:28px;margin:0 0 30px}
#resultsScreen h2{font-size:22px;margin:30px 0 10px;color:#2563eb}
#resultsScreen p{font-size:18px;margin:8px 0;font-weight:900}
#backToMenu{margin-top:30px;width:100%;padding:16px;font-size:19px}
.audioBtn{background:none!important;border:none!important;box-shadow:none!important;padding:4px!important;margin:0 4px;font-size:22px;line-height:1;cursor:pointer}
.audioBtn:hover,.audioBtn:active{background:none!important;transform:none!important}
.audioBtn.off{opacity:0.35}
.resultsCongrats{text-align:center;font-weight:800;margin-top:30px;margin-bottom:18px}
@keyframes spin180{0%{transform:rotateY(0deg)}50%{transform:rotateY(180deg)}100%{transform:rotateY(360deg)}}
.cell.flip{animation:spin180 0.9s ease-in-out}
@keyframes pulse{0%,100%{transform:scale(1);border-color:#e7d6a8}50%{transform:scale(1.15);border-color:#ef4444;box-shadow:0 0 15px rgba(239,68,68,.5)}}
.word.pulse{animation:pulse 1.2s infinite}
@keyframes shake{10%,90%{transform:translate3d(-4px,0,0)}20%,80%{transform:translate3d(8px,0,0)}30%,70%{transform:translate3d(-10px,0,0)}40%,60%{transform:translate3d(10px,0,0)}50%{transform:translate3d(-4px,0,0)}}
#board.shake{animation:shake 0.6s ease-in-out}
.cell.reveal{background:#22c55e!important;color:white;font-weight:900;box-shadow:0 0 15px rgba(34,197,94,.8)}
</style>
</head>
<body>
<div id="shell">

  <!-- WYB√ìR KATEGORII -->
  <div id="categoryScreen">
    <div class="card">
      <h1>üáµüá± Gra S≈Ç√≥wek</h1>
      <p>Wybierz kategoriƒô s≈Ç√≥wek:</p>
      <div class="menuBtns">
        <button class="btnFlat" data-cat="religia">‚úùÔ∏è Religia</button>
        <button class="btnFlat" data-cat="przyroda">üåø Przyroda</button>
        <button class="btnFlat" data-cat="zwierzeta">üêæ Zwierzƒôta</button>
        <button class="btnFlat" data-cat="gwiazdy">‚≠ê Gwiazdy</button>
        <button class="btnFlat small danger" id="backToDW">‚¨ÖÔ∏è Powr√≥t do Droga Wiary</button>
      </div>
    </div>
  </div>

  <!-- MENU WYBORU PLANSZY -->
  <div id="menu">
    <div class="card">
      <h1>üáµüá± Gra S≈Ç√≥wek</h1>
      <p>Wybierz tryb gry:</p>
      <div class="menuBtns">
        <button class="btnFlat" data-mode="classic">Klasyczny 5 √ó 6</button>
        <button class="btnFlat" data-mode="big">Du≈ºa plansza 6 √ó 7</button>
        <button class="btnFlat" data-mode="xl">XL ‚Äì 8 √ó 10 (6-literowe)</button>
        <button class="btnFlat small" id="showResults">üìä Wyniki gry</button>
        <button class="btnFlat small danger" id="exitBtn">üö™ Wyj≈õcie</button>
        <button id="copyLinkBtn" class="btnFlat small">üìã Skopiuj adres gry</button>
        <div class="copyTip">
          ‚ö†Ô∏è Tip: najlepiej skopiowaƒá link i otworzyƒá w <b>Chrome</b> ‚Äì wtedy mo≈ºna dodaƒá grƒô na pulpit i ≈õledziƒá swoje rekordy.
        </div>
      </div>
    </div>
  </div>

  <!-- GRA -->
  <div id="app">
    <header><div id="words"></div></header>
    <div id="board"></div>
    <footer>
      <div style="display:flex;align-items:center;gap:10px">
        <div id="timer" style="--p:100%"><span id="time">60</span></div>
        <button class="iconBtn audioBtn" id="toggleTick" title="Tykanie zegara">üïí</button>
        <button class="iconBtn audioBtn" id="toggleSound" title="D≈∫wiƒôki">üéµ</button>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="goFullscreen()">‚õ∂</button>
        <button class="btn" id="back">MENU</button>
      </div>
    </footer>
  </div>

  <!-- WYGRANA/PRZEGRANA -->
  <div id="overlay">
    <div id="modal">
      <div id="msg"></div><br><br>
      <button class="btn" id="again" style="width:100%;padding:16px;font-size:19px">ZAGRAJ PONOWNIE</button>
    </div>
  </div>

  <!-- WYNIKI -->
  <div id="resultsScreen">
    <h1>Wyniki Gry</h1>
    <div id="globalStats"></div>
    <div id="lastSessionStats"></div>
    <div id="todayStats"></div>
    <button class="btn" id="backToMenu">POWR√ìT DO MENU</button>
    <div class="resultsCongrats">GRATULACJE WYNIK√ìW !!!</div>
  </div>
</div>

<script>
(() => {
  const MODES = {
    classic: { cols:5, rows:6, minLen:3, maxLen:4, words:4, time:60 },
    big: { cols:6, rows:7, minLen:3, maxLen:4, words:4, time:60 },
    xl: { cols:8, rows:10, minLen:6, maxLen:6, words:4, time:60 }
  };
  const BASE_TIME = 60;
  const REVEAL_TIME = 6; // czas w sekundach na oglƒÖdanie s≈Ç√≥w po przegranej (zmie≈Ñ je≈õli chcesz)

  const WORD_SETS = {
    religia: ["B√ìG","WIARA","MODLITWA","KRZY≈ª","ANIO≈Å","EWANGELIA","KO≈öCI√ì≈Å","MSZA","DUCH","≈öWIƒòTY","JEZUS","MARYJA","APOSTO≈Å","GRZECH","MI≈ÅO≈öƒÜ"],
    przyroda: ["LAS","DRZEWO","RZEKA","DESZCZ","G√ìRA","WIATR","MORZE","JEZIORO","KWIAT","LI≈öƒÜ","TRAWA","CHMURA","S≈ÅO≈ÉCE","KSIƒò≈ªYC","GWIAZDA"],
    zwierzeta: ["KOT","PIES","WILK","ORZE≈Å","RYBA","KO≈É","≈ªABA","PTAK","NIED≈πWIED≈π","LIS","JELE≈É","SARNA","≈ª√ì≈ÅW","WƒÑ≈ª","MOTYL"],
    gwiazdy: ["S≈ÅO≈ÉCE","KSIƒò≈ªYC","PLANETA","KOMETA","GWIAZDA","ORION","WENUS","MARS","JOWISZ","SATURN","DROGA","MLECZNA","METEOR","SATELITA"]
  };

  let CURRENT_CATEGORY = "religia";
  let isRevealPhase = false; // czy jeste≈õmy w fazie pokazywania s≈Ç√≥w po przegranej
  let gameOver = false; // <<< NOWA FLAGA ‚Äì jedno ≈∫r√≥d≈Ço prawdy o ko≈Ñcu gry

  const ALPH = "AƒÑBCƒÜDEƒòFGHIJKL≈ÅMN≈ÉO√ìPQRS≈öTUVWXYZ≈π≈ª";
  const DIRS = [{dr:0,dc:1},{dr:1,dc:0},{dr:1,dc:1},{dr:1,dc:-1},{dr:0,dc:-1},{dr:-1,dc:0},{dr:-1,dc:-1},{dr:-1,dc:1}];

  const categoryScreen = document.getElementById("categoryScreen");
  const menu = document.getElementById("menu");
  const app = document.getElementById("app");
  const board = document.getElementById("board");
  const wordsEl = document.getElementById("words");
  const overlay = document.getElementById("overlay");
  const msg = document.getElementById("msg");
  const back = document.getElementById("back");
  const again = document.getElementById("again");
  const timeEl = document.getElementById("time");
  const timerEl = document.getElementById("timer");
  const showResultsBtn = document.getElementById("showResults");
  const resultsScreen = document.getElementById("resultsScreen");
  const backToMenuBtn = document.getElementById("backToMenu");
  const globalStatsEl = document.getElementById("globalStats");
  const lastSessionStatsEl = document.getElementById("lastSessionStats");
  const todayStatsEl = document.getElementById("todayStats");
  const exitBtn = document.getElementById("exitBtn");
  const backToDW = document.getElementById("backToDW");

  let GAME = { rows: 6, cols: 5 };
  let words4 = [];
  let active = new Set();
  let found = new Set();
  let grid = [];
  let cells = [];
  let timer = null;
  let timeLeft = BASE_TIME;
  let dragging = false;
  let startCell = null;
  let path = [];
  let wordPositions = [];
  let activeCount = Math.max(1, Math.min(4, Number(localStorage.getItem("ACTIVE_COUNT")) || 2));

  const clickSound = new Audio('sounds/click.mp3');
  const tickSound = new Audio('sounds/tick.mp3');
  const recordsMusic = new Audio('sounds/records_loop.mp3');
  const fanfareSound = new Audio('sounds/fanfare.mp3');
  const loseSound = new Audio('sounds/lose.mp3');
  clickSound.volume = 0.6; tickSound.volume = 0.6; recordsMusic.volume = 0.9; recordsMusic.loop = true;
  fanfareSound.volume = 0.4; loseSound.volume = 0.8;
  let soundOn = (localStorage.getItem("SOUND_ON") ?? "1") !== "0";
  let tickOn = (localStorage.getItem("TICK_ON") ?? "1") !== "0";

  function syncAudioFlags() {
    const muteAll = !soundOn;
    [clickSound, tickSound, recordsMusic, fanfareSound, loseSound].forEach(a => a.muted = muteAll);
    tickSound.muted = muteAll || !tickOn;
    if (muteAll) try { recordsMusic.pause(); recordsMusic.currentTime = 0; } catch(e){}
  }
  function renderAudioButtons() {
    document.getElementById("toggleTick").classList.toggle("off", !tickOn || !soundOn);
    document.getElementById("toggleSound").classList.toggle("off", !soundOn);
  }
  function safePlay(audio, {reset=true}={}) {
    try { if (!audio || audio.muted) return; if (reset) audio.currentTime = 0; audio.play().catch(()=>{}); } catch(e){}
  }
  syncAudioFlags(); renderAudioButtons();

  document.getElementById("toggleSound").onclick = () => { soundOn = !soundOn; localStorage.setItem("SOUND_ON", soundOn?"1":"0"); syncAudioFlags(); renderAudioButtons(); };
  document.getElementById("toggleTick").onclick = () => { tickOn = !tickOn; localStorage.setItem("TICK_ON", tickOn?"1":"0"); syncAudioFlags(); renderAudioButtons(); };

  document.querySelectorAll('[data-cat]').forEach(btn => {
    btn.onclick = () => {
      CURRENT_CATEGORY = btn.dataset.cat;
      categoryScreen.style.display = "none";
      menu.style.display = "flex";
    };
  });

  backToDW.onclick = () => {
    window.location.href = "https://drogawiary.github.io";
  };

  document.querySelectorAll("[data-mode]").forEach(btn => {
    btn.onclick = () => {
      const m = MODES[btn.dataset.mode];
      GAME = { rows: m.rows, cols: m.cols };
      updateBoardCSS();
      startGame(m.minLen, m.maxLen, m.words);
    };
  });

  function updateBoardCSS() {
    board.style.gridTemplateColumns = `repeat(${GAME.cols}, 1fr)`;
    board.style.gridTemplateRows = `repeat(${GAME.rows}, 1fr)`;
  }

  function getWordsForCategory(minLen, maxLen) {
    return WORD_SETS[CURRENT_CATEGORY].filter(w => w.length >= minLen && w.length <= maxLen);
  }

  function pickWords(minLen, maxLen, count) {
    const pool = getWordsForCategory(minLen, maxLen);
    const out = [];
    while (out.length < count && pool.length) {
      out.push(pool.splice(Math.floor(Math.random() * pool.length), 1)[0]);
    }
    while (out.length < count) out.push("DOM");
    return out;
  }

  function applyActiveFromCount() { active = new Set(words4.slice(0, activeCount)); }

  function renderChips() {
    wordsEl.innerHTML = "";
    words4.forEach(w => {
      const s = document.createElement("span");
      s.className = "word off";
      s.textContent = w;
      s.onclick = () => {
        if (active.has(w)) { if (active.size <= 1) return; active.delete(w); }
        else active.add(w);
        activeCount = active.size;
        localStorage.setItem("ACTIVE_COUNT", activeCount);
        found.clear();
        wordPositions = [];
        buildRound();
      };
      wordsEl.appendChild(s);
    });
    updateChips();
  }

  function updateChips() {
    [...wordsEl.children].forEach(chip => {
      const w = chip.textContent;
      chip.className = "word " + (found.has(w) ? "found" : active.has(w) ? "on" : "off");
    });
  }

  function buildGrid() {
    const g = Array.from({length: GAME.rows}, () => Array(GAME.cols).fill(null));
    wordPositions = [];
    const list = [...active];
    for (let i = list.length-1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [list[i], list[j]] = [list[j], list[i]]; }
    for (const w of list) {
      let placed = false;
      for (let t = 0; t < 500; t++) {
        const d = DIRS[Math.floor(Math.random() * DIRS.length)];
        const r0 = Math.floor(Math.random() * GAME.rows);
        const c0 = Math.floor(Math.random() * GAME.cols);
        const rE = r0 + d.dr * (w.length - 1);
        const cE = c0 + d.dc * (w.length - 1);
        if (rE < 0 || rE >= GAME.rows || cE < 0 || cE >= GAME.cols) continue;
        let ok = true;
        for (let i = 0; i < w.length; i++) if (g[r0 + d.dr * i][c0 + d.dc * i] !== null) { ok = false; break; }
        if (ok) {
          for (let i = 0; i < w.length; i++) g[r0 + d.dr * i][c0 + d.dc * i] = w[i];
          wordPositions.push({word: w, path: Array.from({length: w.length}, (_,k) => ({r: r0 + d.dr * k, c: c0 + d.dc * k})) });
          placed = true;
          break;
        }
      }
    }
    for (let r = 0; r < GAME.rows; r++) for (let c = 0; c < GAME.cols; c++) if (g[r][c] === null) g[r][c] = ALPH[Math.floor(Math.random() * ALPH.length)];
    return g;
  }

  function renderBoard() {
    board.innerHTML = "";
    cells = [];
    for (let r = 0; r < GAME.rows; r++) for (let c = 0; c < GAME.cols; c++) {
      const el = document.createElement("div");
      el.className = "cell";
      el.textContent = grid[r][c];
      el.dataset.r = r; el.dataset.c = c;
      board.appendChild(el);
      cells.push(el);
    }
  }

  function idx(p) { return p.r * GAME.cols + p.c; }
  function clearSel() { cells.forEach(el => el.classList.remove("sel")); }
  function paint(p) { clearSel(); p.forEach(x => cells[idx(x)].classList.add("sel")); }
  function line(a, b) {
    const dr = b.r - a.r, dc = b.c - a.c;
    const sdr = dr === 0 ? 0 : dr > 0 ? 1 : -1;
    const sdc = dc === 0 ? 0 : dc > 0 ? 1 : -1;
    const adr = Math.abs(dr), adc = Math.abs(dc);
    if (!((adr === 0 && adc > 0) || (adc === 0 && adr > 0) || (adr === adc && adr > 0))) return [];
    const n = Math.max(adr, adc);
    const out = [];
    let rr = a.r, cc = a.c;
    for (let i = 0; i <= n; i++) { out.push({r: rr, c: cc}); rr += sdr; cc += sdc; }
    return out;
  }

  board.addEventListener("pointerdown", e => {
    const el = e.target.closest(".cell");
    if (!el) return;
    dragging = true;
    board.setPointerCapture(e.pointerId);
    startCell = {r: +el.dataset.r, c: +el.dataset.c};
    path = [startCell];
    paint(path);
  });
  board.addEventListener("pointermove", e => {
    if (!dragging) return;
    const el = document.elementFromPoint(e.clientX, e.clientY)?.closest(".cell");
    if (!el) return;
    const cur = {r: +el.dataset.r, c: +el.dataset.c};
    path = line(startCell, cur);
    paint(path);
  });
  board.addEventListener("pointerup", () => {
    if (!dragging) return;
    dragging = false;
    clearSel();
    if (path.length >= 3) {
      const txt = path.map(p => grid[p.r][p.c]).join("");
      const rev = txt.split("").reverse().join("");
      for (const w of active) {
        if (found.has(w)) continue;
        if (txt === w || rev === w) {
          found.add(w);
          updateChips();
          path.forEach(p => cells[idx(p)].classList.add("hit", "flip"));
          if (found.size === active.size) win();
          break;
        }
      }
    }
    path = [];
  });

  function startTimer() {
    clearInterval(timer);
    timeLeft = isRevealPhase ? REVEAL_TIME : BASE_TIME;
    timeEl.textContent = timeLeft;
    timerEl.style.setProperty("--p", "100%");
    let lastSecond = -1;
    timer = setInterval(() => {
      timeLeft--;
      timeEl.textContent = timeLeft;
      timerEl.style.setProperty("--p", (timeLeft / (isRevealPhase ? REVEAL_TIME : BASE_TIME) * 100) + "%");
      if (timeLeft !== lastSecond && timeLeft > 0) { lastSecond = timeLeft; if (soundOn && tickOn) safePlay(tickSound); }
      if (timeLeft <= 0) {
        if (isRevealPhase) {
          // koniec fazy oglƒÖdania s≈Ç√≥w ‚Üí pokazujemy overlay
          isRevealPhase = false;
          msg.innerHTML = "‚è±Ô∏è Czas siƒô sko≈Ñczy≈Ç!<br>Spr√≥buj jeszcze raz.";
          overlay.style.display = "flex";
          clearInterval(timer);
        } else {
          lose();
        }
      }
    }, 1000);
  }

  function win() {
    if (gameOver) return;   // ‚õî twarda blokada
    gameOver = true;

    clearInterval(timer);
    isRevealPhase = false;
    updateStats(true);
    if (soundOn) safePlay(fanfareSound);
    msg.innerHTML = "üéâ Gratulacje!<br>Znaleziono wszystkie s≈Çowa!";
    overlay.style.display = "flex";
  }

  function lose() {
    if (gameOver) return;   // ‚õî twarda blokada
    gameOver = true;

    updateStats(false);
    if (soundOn) safePlay(loseSound);
    board.classList.add("shake");
    setTimeout(() => board.classList.remove("shake"), 600);

    // Natychmiast pokazujemy nieodgadniƒôte s≈Çowa
    wordPositions.forEach(pos => {
      if (!found.has(pos.word)) {
        pos.path.forEach(p => cells[idx(p)].classList.add("reveal"));
      }
    });

    // Zaczynamy fazƒô oglƒÖdania ‚Äì timer na REVEAL_TIME sekund
    isRevealPhase = true;
    startTimer(); // restart timera z nowƒÖ warto≈õciƒÖ
  }

  function buildRound() {
    gameOver = false;   // <<< reset flagi na starcie nowej rundy
    isRevealPhase = false;
    overlay.style.display = "none";
    found.clear();
    wordPositions = [];
    grid = buildGrid();
    renderBoard();
    updateChips();
    startTimer();
  }

  function startGame(minLen, maxLen, wordCount) {
    resultsScreen.style.display = "none";
    recordsMusic.pause(); recordsMusic.currentTime = 0;
    menu.style.display = "none";
    app.style.display = "flex";
    words4 = pickWords(minLen, maxLen, wordCount);
    applyActiveFromCount();
    renderChips();
    buildRound();
  }

  if (!localStorage.getItem("gameStats")) localStorage.setItem("gameStats", JSON.stringify({startDate: new Date().toISOString().split('T')[0], stats: {}}));
  function updateStats(isWin) {
    const today = new Date().toISOString().split('T')[0];
    const stats = JSON.parse(localStorage.getItem("gameStats"));
    if (!stats.stats[today]) stats.stats[today] = {wins:0, losses:0};
    isWin ? stats.stats[today].wins++ : stats.stats[today].losses++;
    localStorage.setItem("gameStats", JSON.stringify(stats));
  }

  function showResults() {
    menu.style.display = "none";
    resultsScreen.style.display = "flex";
    if (soundOn) { recordsMusic.currentTime = 0; safePlay(recordsMusic, {reset:false}); }
    const stats = JSON.parse(localStorage.getItem("gameStats"));
    const startDate = stats.startDate;
    const dailyStats = stats.stats;
    let globalWins = 0, globalLosses = 0;
    for (const day in dailyStats) { globalWins += dailyStats[day].wins || 0; globalLosses += dailyStats[day].losses || 0; }
    globalStatsEl.innerHTML = `<h2>Globalnie (od ${startDate})</h2><p>Wygrane rundy: <strong>${globalWins}</strong></p><p>Przegrane rundy: <strong>${globalLosses}</strong></p>`;
    const today = new Date().toISOString().split('T')[0];
    const todayWins = dailyStats[today]?.wins || 0;
    const todayLosses = dailyStats[today]?.losses || 0;
    todayStatsEl.innerHTML = `<h2>Dzi≈õ (${today})</h2><p>Wygrane: <strong>${todayWins}</strong></p><p>Przegrane: <strong>${todayLosses}</strong></p>`;
    const dates = Object.keys(dailyStats).sort().reverse();
    let lastSessionDate = null;
    for (const d of dates) if (d !== today && (dailyStats[d].wins > 0 || dailyStats[d].losses > 0)) { lastSessionDate = d; break; }
    if (lastSessionDate) {
      const lastWins = dailyStats[lastSessionDate].wins || 0;
      const lastLosses = dailyStats[lastSessionDate].losses || 0;
      lastSessionStatsEl.innerHTML = `<h2>Ostatnia sesja (${lastSessionDate})</h2><p>Wygrane: <strong>${lastWins}</strong></p><p>Przegrane: <strong>${lastLosses}</strong></p>`;
    } else lastSessionStatsEl.innerHTML = `<h2>Ostatnia sesja</h2><p>Brak wcze≈õniejszych sesji</p>`;
  }

  back.onclick = () => { 
    clearInterval(timer); 
    isRevealPhase = false; 
    gameOver = false;   // <<< reset przy powrocie do menu
    app.style.display = "none"; 
    menu.style.display = "flex"; 
  };
  again.onclick = () => { words4 = pickWords(GAME.minLen || 3, GAME.maxLen || 4, GAME.words || 4); applyActiveFromCount(); renderChips(); buildRound(); };
  showResultsBtn.onclick = showResults;
  backToMenuBtn.onclick = () => { recordsMusic.pause(); recordsMusic.currentTime = 0; resultsScreen.style.display = "none"; menu.style.display = "flex"; };

  exitBtn.onclick = () => {
    if (document.fullscreenElement) document.exitFullscreen();
    clearInterval(timer);
    isRevealPhase = false;
    gameOver = false;   // <<< reset przy wyj≈õciu do kategorii
    recordsMusic.pause(); recordsMusic.currentTime = 0;
    menu.style.display = "none";
    app.style.display = "none";
    overlay.style.display = "none";
    resultsScreen.style.display = "none";
    categoryScreen.style.display = "flex";
  };

  document.getElementById("copyLinkBtn").onclick = async () => {
    try { 
      await navigator.clipboard.writeText(location.href);
      document.getElementById("copyLinkBtn").textContent = "‚úÖ Skopiowano adres";
      setTimeout(() => document.getElementById("copyLinkBtn").textContent = "üìã Skopiuj adres gry", 1500);
    } catch(e) { alert("Nie uda≈Ço siƒô"); }
  };

  document.addEventListener('click', e => {
    if (soundOn && e.target.closest('.btn, .btnBig, .iconBtn, .btnFlat')) safePlay(clickSound);
  });

  if ("serviceWorker" in navigator) window.addEventListener("load", () => navigator.serviceWorker.register("./service-worker.js").catch(() => {}));
})();
</script>
<script>
function goFullscreen() {
  const el = document.documentElement;
  document.fullscreenElement ? document.exitFullscreen() : el.requestFullscreen();
}
</script>
</body>
</html>
